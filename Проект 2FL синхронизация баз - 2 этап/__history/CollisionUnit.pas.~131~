{unit CollisionUnit;
Версия: 2.1 от 28.02
Разработчик: Соколовский Николай
Sokolovskynik@gmail.com

Зависимости: MainUnit, DateUtils
Юнит хранит интерфейес окна и логику разрешений коллизий по полям}
unit CollisionUnit;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Grids, Vcl.ExtCtrls,
  Vcl.ImgList, Vcl.Imaging.pngimage,
  DateUtils;

type
  TCollisionForm = class(TForm)
    Label1: TLabel;
    CompairStringGrid: TStringGrid;
    NextBackImage: TImage;
    OkButton: TButton;
    RadioGroup1: TRadioGroup;
    FBtoSQLImage: TImage;
    SQLtoFBImage: TImage;
    EqImage: TImage;
    CancelButton: TButton;
    procedure FormCreate(Sender: TObject);
    procedure CompairStringGridDrawCell(Sender: TObject; ACol, ARow: Integer;
      Rect: TRect; State: TGridDrawState);
    procedure OkButtonClick(Sender: TObject);
    procedure SkipButtonClick(Sender: TObject);
    procedure CompairStringGridSelectCell(Sender: TObject; ACol, ARow: Integer;
      var CanSelect: Boolean);
    procedure RadioGroup1Click(Sender: TObject);
    procedure CancelButtonClick(Sender: TObject);
  private
    { Private declarations }
    iWight, iHeight: integer;
  public
   arDirect: array of integer;     //0 - не определено, 1 - FB-SQLite,
   sSQLQuery, sFBQuery: string;    //2 - SQLite - FB, 3 - равно
  end;

var
  CollisionForm: TCollisionForm;

implementation

{$R *.dfm}

uses MainUnit;

//прорисовка стрелок
procedure TCollisionForm.CancelButtonClick(Sender: TObject);
begin
 CollisionForm.Close;
end;

procedure TCollisionForm.CompairStringGridDrawCell(Sender: TObject; ACol,
  ARow: Integer; Rect: TRect; State: TGridDrawState);

begin
  if (Acol = 2) and (aRow <> 0) then
   begin
      case arDirect[aRow-1] of
        0: CompairStringGrid.Canvas.StretchDraw(Rect, NextBackImage.Picture.Graphic);
        1: CompairStringGrid.Canvas.StretchDraw(Rect, FBtoSQLImage.Picture.Graphic);
        2: CompairStringGrid.Canvas.StretchDraw(Rect, SQLtoFBImage.Picture.Graphic);
        3: CompairStringGrid.Canvas.StretchDraw(Rect, EqImage.Picture.Graphic);
     end;
   end;
//выделение коллизионных записей
if (aCol<>2) and (aRow>0)  then
 begin
 if CompairStringGrid.Cells[1, aRow] <> CompairStringGrid.Cells[3, aRow] then
    begin
    CompairStringGrid.Canvas.Font.Style:=[fsBold];
    CompairStringGrid.Canvas.Font.Color := clRed;
    CompairStringGrid.Canvas.FillRect(rect);
        CompairStringGrid.Canvas.TextOut(rect.left+2, rect.top+2,
      CompairStringGrid.cells[acol, arow]);
    end;
 end;
end;

//отображение выбора направления синхронизации пользователем
procedure TCollisionForm.CompairStringGridSelectCell(Sender: TObject; ACol,
  ARow: Integer; var CanSelect: Boolean);
var
i: integer;
begin
  if (Acol = 2) and (aRow <> 0) then
   begin
     with Mainform do
      begin
       case arDirect[aRow-1] of
        0: arDirect[aRow-1] := 1;
        1: arDirect[aRow-1] := 2;
        2: arDirect[aRow-1] := 0;
        3: arDirect[aRow-1] := 3;
       end;
      end;
   CompairStringGrid.Repaint;
   end;
for I := 0 to Length(arDirect)-1 do
  if arDirect[i]=0 then begin
                        OkButton.Enabled := false;
                        break;
                        end
                   else OkButton.Enabled := true;
end;

//действие при создании окна
procedure TCollisionForm.FormCreate(Sender: TObject);
var
 i: integer;
begin
 //Заполняем шапку таблицы
 CompairStringGrid.Cells[0,0] := 'Metaname';
 CompairStringGrid.Cells[1,0] := 'FireBird';
 CompairStringGrid.Cells[3,0] := 'SQLite';

 //загрузка рисунка "не определено"
 for I := 1 to CompairStringGrid.RowCount - 1 do
   begin
    iWight := NextBackImage.Picture.Width;
    iHeight := NextBackImage.Picture.Height;
    CompairStringGrid.ColWidths[2] := iWight;
    CompairStringGrid.RowHeights[i] := iHeight;
   end;
  OkButton.Enabled := false;
end;

//принять задачу
procedure TCollisionForm.OkButtonClick(Sender: TObject);
var
 i: integer;
begin
 //генерация запросов
 sSQLQuery := ' SET ';
 sFBQuery := ' SET ';
 for i := 0 to CompairStringGrid.RowCount - 1 do
  begin
    //ВЫБРАН FB
    case arDirect[i] of
    2:begin
      sFBQuery := sFBQuery + MainForm.arMetaNameField[i].sFBField + ' = ';
      //если строка
      if MainForm.arMetaNameField[i].sDataType = 'str' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + #39 +
                StringReplace(CompairStringGrid.Cells[3, i+1], #39 ,#39+#39, [rfReplaceAll])
                 + #39;
          end;
      //если текстовый блоб
      if MainForm.arMetaNameField[i].sDataType = 'txt' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + #39 +
                StringReplace(CompairStringGrid.Cells[3, i+1], #39 ,#39+#39, [rfReplaceAll])
                 + #39;
          end;
      //Если число
      if MainForm.arMetaNameField[i].sDataType = 'int' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + CompairStringGrid.Cells[3, i+1];
          end;
      //Если дробное число
      if MainForm.arMetaNameField[i].sDataType = 'flt' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + StringReplace(CompairStringGrid.Cells[3, i+1],
                    ',','.',[rfReplaceAll]);
          end;
      //если дата
      if MainForm.arMetaNameField[i].sDataType = 'dat' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + #39 + CompairStringGrid.Cells[3, i+1] + #39;
          end;
      //если логика
      if MainForm.arMetaNameField[i].sDataType = 'boo' then
          begin
           if CompairStringGrid.Cells[3, i+1] = '' then
               sFBQuery := sFBQuery + 'null'
               else sFBQuery :=
                sFBQuery + CompairStringGrid.Cells[3, i+1];
          end;
      if i <> CompairStringGrid.RowCount - 1 then
         sFBQuery := sFBQuery + ', ';
      end;
     //выбран SQLite
     1:Begin
      sSQLQuery := sSQLQuery + MainForm.arMetaNameField[i].sSQLField + ' = ';
      //если строка
      if MainForm.arMetaNameField[i].sDataType = 'str' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + #39 +
                StringReplace(CompairStringGrid.Cells[1, i+1], #39 ,#39+#39, [rfReplaceAll])
                 + #39;
          end;
      //если текстовый блоб
      if MainForm.arMetaNameField[i].sDataType = 'txt' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + #39 +
                StringReplace(CompairStringGrid.Cells[1, i+1], #39 ,#39+#39, [rfReplaceAll])
                 + #39;
          end;
      //Если число
      if MainForm.arMetaNameField[i].sDataType = 'int' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + CompairStringGrid.Cells[1, i+1];
          end;
      //Если дробное число
      if MainForm.arMetaNameField[i].sDataType = 'flt' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + #39 + StringReplace(CompairStringGrid.Cells[1, i+1],
                    ',','.',[rfReplaceAll]) + #39;
          end;
      //если дата
      if MainForm.arMetaNameField[i].sDataType = 'dat' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + #39 +
                 IntToStr(
                  DateTimeToUnix(
                   StrToDateTime(CompairStringGrid.Cells[1, i+1]))) + #39;
          end;
      //если логика
      if MainForm.arMetaNameField[i].sDataType = 'boo' then
          begin
           if CompairStringGrid.Cells[1, i+1] = '' then
               sSQLQuery := sSQLQuery + 'null'
               else sSQLQuery :=
                sSQLQuery + CompairStringGrid.Cells[1, i+1];
          end;
     if i <> CompairStringGrid.RowCount - 1 then sSQLQuery := sSQLQuery + ', ';
     End;
    end;
  end;
 CollisionForm.Close;
end;

//выбор пользователм направления для всех полей
procedure TCollisionForm.RadioGroup1Click(Sender: TObject);
var
i: integer;
begin
  if RadioGroup1.ItemIndex=0 then  //если выбрано FB->SQLite
   begin
     for I := 0 to length (arDirect) - 1 do
       if arDirect[i] <> 3 then arDirect[i] := 1;
    end
    else
    begin
      for I := 0 to length (arDirect) - 1 do
       if arDirect[i] <> 3 then arDirect[i] := 2;
    end;
   CompairStringGrid.Repaint;
 for I := 0 to Length(arDirect)-1 do
  if arDirect[i]=0 then begin
                        OkButton.Enabled := false;
                        break;
                        end
                   else OkButton.Enabled := true;
end;

//пропустить эту запись
procedure TCollisionForm.SkipButtonClick(Sender: TObject);
begin
 CollisionForm.Close;
end;

end.
